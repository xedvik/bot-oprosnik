# Telegram Опросник с Google Sheets

## Особенности
- Автоматическое создание и настройка структуры Google таблицы
- Поддержка вариантов ответов для каждого вопроса
- Возможность ввода своего варианта ответа (только для вопросов без предопределенных вариантов)
- Запрет свободного ввода для вопросов с предопределенными вариантами ответов
- Администрирование через Telegram и Google таблицу
- Сохранение ответов в московском часовом поясе
- Автоматическое восстановление при сбоях
- Подробная статистика ответов
- Гибкая система управления администраторами
- Возможность редактирования и удаления вопросов
- Сброс прохождения опроса для отдельных пользователей

## Административные команды
### Управление вопросами
- `/add_question` - Добавить новый вопрос
- `/edit_question` - Редактировать существующий вопрос
- `/delete_question` - Удалить вопрос
- `/list_questions` - Показать список всех вопросов

### Управление администраторами
- `/add_admin` - Добавить нового администратора
- `/remove_admin` - Удалить администратора
- `/list_admins` - Показать список администраторов

### Управление данными
- `/stats` - Показать статистику опроса
- `/clear_data` - Очистить все ответы и статистику
- `/reset_user` - Сбросить прохождение опроса для пользователя
- `/restart` - Перезапустить бота и обновить структуру опроса

## Настройка бота

### 1. Подготовка Google Sheets
1. Создайте проект в Google Cloud Console
2. Включите Google Sheets API
3. Создайте сервисный аккаунт и скачайте credentials.json
4. Создайте новую Google таблицу
5. Предоставьте доступ сервисному аккаунту к таблице (права редактора)
6. Скопируйте ID таблицы из URL и вставьте в config.py

### 2. Настройка переменных окружения
Создайте файл .env со следующими параметрами:
env
BOT_TOKEN=ваш_токен_бота
SPREADSHEET_ID=id_вашей_таблицы
GOOGLE_CREDENTIALS_FILE=путь_к_credentials.json


### 3. Структура таблицы
Бот автоматически создаст следующие листы:
- "Вопросы с вариантами ответов" - структура опроса
- "Ответы" - ответы пользователей
- "Статистика" - статистика по вариантам ответов
- "Админы" - список администраторов

## Требования
- Python 3.11+
- Docker и Docker Compose
- Доступ к Google Sheets API
- Telegram Bot Token

## Запуск бота
1. Склонируйте репозиторий
2. Создайте файл .env и заполните его параметрами
3. Запустите бота с помощью Docker Compose или start.sh

docker-compose up --build

## Процесс опроса
1. Пользователь начинает опрос командой /start
2. Последовательно отвечает на все вопросы
3. Подтверждает свои ответы
4. Данные сохраняются в таблицу

## Обновление вопросов
1. Отредактируйте вопросы через команды бота или напрямую в таблице
2. Бот автоматически обновит структуру опроса

## Безопасность
- Доступ к административным командам только для авторизованных пользователей
- Защита от повторного прохождения опроса
- Логирование всех действий администраторов
- Безопасное хранение учетных данных через переменные окружения

# Telegram Бот для Опросов

## Оптимизация для высокой нагрузки

Бот оптимизирован для работы с большим количеством пользователей (до 350+ одновременно) с учетом ограничений Google Sheets API (60 запросов в минуту).

### Реализованные оптимизации:

1. **Многоуровневое кэширование**:
   - Кэширование вопросов (через `QuestionsCache`)
   - Кэширование данных пользователей 
   - Кэширование системных сообщений
   - Кэширование списка администраторов
   - Кэширование постов

2. **Контроль частоты запросов (Rate Limiting)**:
   - Подсчет количества запросов к API в минуту
   - Асинхронная очередь для запросов, превышающих лимит
   - Асинхронное выполнение запросов с учетом лимитов

3. **Асинхронные операции**:
   - Асинхронные методы доступа к Google Sheets
   - Асинхронное сохранение ответов пользователей
   - Асинхронное обновление статистики

### Детали реализации

#### Класс SheetsCache

Синглтон-класс для кэширования данных из Google Sheets с использованием следующих механизмов:
- Блокировки для потокобезопасности (`threading.RLock`)
- Настраиваемым TTL (time-to-live) для разных типов данных
- Контролем частоты запросов

```python
async def execute_with_rate_limit(self, func, *args, **kwargs):
    """Выполняет функцию с учетом ограничения на количество запросов"""
    with self._lock:
        current_time = time.time()
        if current_time - self._requests_time >= 60:
            # Прошла минута, сбрасываем счетчик
            self._requests_count = 0
            self._requests_time = current_time
        
        if self._requests_count < self._requests_limit:
            # Можем выполнить запрос немедленно
            self._requests_count += 1
            return func(*args, **kwargs)
        else:
            # Ставим запрос в очередь
            future = asyncio.Future()
            self._requests_queue.append((func, args, kwargs, future))
            
            # Запускаем обработку очереди
            asyncio.create_task(self._process_queue())
            
            # Ждем результата
            return await future
```

#### Асинхронные методы в GoogleSheets

Добавлены асинхронные методы для выполнения операций с Google Sheets с учетом ограничения запросов:

```python
async def async_is_user_exists(self, telegram_id: int) -> bool:
    """Асинхронная проверка существования пользователя с учетом ограничения запросов"""
    return await sheets_cache.execute_with_rate_limit(self.is_user_exists, telegram_id)
```

### Рекомендации по масштабированию

1. **При дальнейшем росте нагрузки**:
   - Увеличить время жизни кэшей для снижения количества запросов
   - Рассмотреть возможность миграции на другое хранилище данных (PostgreSQL, MongoDB)

2. **Горизонтальное масштабирование**:
   - Добавить Redis для распределенного кэширования между несколькими инстансами бота
   - Внедрить шардирование при хранении данных

### Настройка параметров кэширования

Параметры TTL можно настроить в файле `src/utils/sheets_cache.py`:

```python
# Время жизни кэша пользователей (5 минут)
self._users_cache_ttl = 300

# Время жизни кэша сообщений (10 минут)
self._messages_cache_ttl = 600
```

## Последние обновления

### Запрет свободного ввода для вопросов с вариантами

**Описание**: Реализован запрет свободного ввода для вопросов, у которых уже определены варианты ответов. При попытке ввести произвольный текст система выдаст сообщение об ошибке и повторно отобразит доступные варианты ответов.

**Как работает**: 
1. При получении ответа от пользователя происходит проверка на соответствие ответа доступным вариантам
2. Если ответ не соответствует ни одному из вариантов, система отправляет сообщение "❌ Пожалуйста, выберите один из предложенных вариантов:"
3. Одновременно с сообщением повторно отображается клавиатура с доступными вариантами

**Преимущества**:
- Улучшенная структура и согласованность данных
- Предотвращение ошибок ввода
- Более точная статистика опросов